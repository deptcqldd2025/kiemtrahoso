<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Nh√¢n S·ª± v4.4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .admin-header { background: #dc3545; color: white; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .user-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; border-left: 5px solid #198754; transition: 0.2s; }
        .user-card:hover { transform: translateY(-2px); }
        .user-card.blocked { border-left-color: #dc3545; background-color: #fff5f5; opacity: 0.8; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .badge-group-0 { background: #dc3545; color: white; } /* ƒê·ªè - L√£nh ƒë·∫°o */
        .badge-group-common { background: #0d6efd; color: white; } /* Xanh - T·ªï */
    </style>
</head>
<body>

    <div class="admin-header d-flex align-items-center justify-content-between">
        <h5 class="m-0"><i class="fas fa-users-cog"></i> Qu·∫£n L√Ω Nh√¢n S·ª±</h5>
        <a href="index.html" class="btn btn-sm btn-light text-danger fw-bold"><i class="fas fa-home"></i> Trang ch·ªß</a>
    </div>

    <div class="container pb-5">
        <div class="row g-2 mb-3">
            <div class="col-12">
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="T√¨m t√™n, email..." oninput="renderList()">
                </div>
            </div>
            <div class="col-12 text-muted small d-flex justify-content-between">
                <span>T·ªïng s·ªë: <b id="totalUsers">0</b></span>
                <span>Version 4.4</span>
            </div>
        </div>
        <div id="userListContainer">
            <div class="text-center mt-5"><div class="spinner-border text-danger"></div><p class="mt-2 text-muted">ƒêang t·∫£i...</p></div>
        </div>
    </div>

    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white"><h5 class="modal-title">C·∫≠p nh·∫≠t nh√¢n vi√™n</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="editKey">
                    <div class="mb-3 text-center">
                        <img id="editAvatar" src="" class="avatar mb-2">
                        <div id="editEmail" class="text-muted small fw-bold"></div>
                    </div>
                    
                    <div class="mb-3"><label class="form-label fw-bold">H·ªç v√† T√™n:</label><input type="text" id="editName" class="form-control"></div>
                    <div class="mb-3"><label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i:</label><input type="text" id="editPhone" class="form-control"></div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Thu·ªôc Nh√≥m / T·ªï:</label>
                        <select id="editGroup" class="form-select border-primary bg-light">
                            <option value="0">‚≠ê Nh√≥m 0: L√£nh ƒë·∫°o / CBKT (Full Quy·ªÅn)</option>
                            <option value="1">üî∑ Nh√≥m 1</option>
                            <option value="2">üî∑ Nh√≥m 2</option>
                            <option value="3">üî∑ Nh√≥m 3</option>
                            <option value="4">üî∑ Nh√≥m 4</option>
                        </select>
                        <div class="form-text small text-muted fst-italic mt-1">* Nh√≥m 0 xem v√† s·ª≠a ƒë∆∞·ª£c t·∫•t c·∫£. C√°c nh√≥m kh√°c h·ªó tr·ª£ l·∫´n nhau trong nh√≥m.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyALxXDNbFdXkI7XvHqiSNb1jnKjj0CbYnE",
            authDomain: "qldd-2025.firebaseapp.com",
            databaseURL: "https://qldd-2025-default-rtdb.firebaseio.com",
            projectId: "qldd-2025",
            storageBucket: "qldd-2025.firebasestorage.app",
            messagingSenderId: "84684010166",
            appId: "1:84684010166:web:bd9c3b5ae4227ee2812c17"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const ADMIN_EMAIL = 'deptc.qldd2025@gmail.com';
        let allUsers = {};

        auth.onAuthStateChanged(user => {
            if (!user) { window.location.href = "index.html"; return; }
            const userKey = user.email.replace(/\./g, '_');
            db.ref('app_users/' + userKey).once('value').then(snap => {
                const uData = snap.val();
                if (user.email === ADMIN_EMAIL || (uData && uData.group == 0)) { initData(); } // Group 0 c≈©ng v√†o ƒë∆∞·ª£c
                else { alert("B·∫°n kh√¥ng ph·∫£i L√£nh ƒë·∫°o/CBKT (Nh√≥m 0)!"); window.location.href = "index.html"; }
            });
        });

        function initData() { db.ref('app_users').on('value', snap => { allUsers = snap.val() || {}; renderList(); }); }

        function renderList() {
            const container = document.getElementById('userListContainer');
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            container.innerHTML = '';
            
            const list = Object.entries(allUsers).filter(([key, u]) => (u.real_name + u.email).toLowerCase().includes(keyword));
            document.getElementById('totalUsers').innerText = list.length;

            if(list.length === 0) { container.innerHTML = '<div class="text-center mt-4 text-muted">Tr·ªëng</div>'; return; }

            list.forEach(([key, u]) => {
                const grp = u.group !== undefined ? u.group : 4; // M·∫∑c ƒë·ªãnh nh√≥m 4
                const grpBadge = grp == 0 ? 
                    `<span class="badge badge-group-0 ms-1">L√£nh ƒë·∫°o (0)</span>` : 
                    `<span class="badge badge-group-common ms-1">Nh√≥m ${grp}</span>`;

                container.innerHTML += `
                <div class="user-card p-3 ${u.is_blocked?'blocked':''}">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center" style="flex-grow: 1;">
                            <img src="${u.photo || 'https://via.placeholder.com/50'}" class="avatar me-3">
                            <div>
                                <h6 class="m-0 fw-bold text-dark">${u.real_name||'No Name'} ${grpBadge}</h6>
                                <div class="small text-muted">${u.email}</div>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${key}')"><i class="fas fa-edit"></i></button>
                            ${u.is_blocked 
                                ? `<button class="btn btn-sm btn-outline-success ms-1" onclick="toggleBlock('${key}',false)"><i class="fas fa-unlock"></i></button>` 
                                : `<button class="btn btn-sm btn-outline-danger ms-1" onclick="toggleBlock('${key}',true)"><i class="fas fa-lock"></i></button>`}
                        </div>
                    </div>
                </div>`;
            });
        }

        function openEditModal(key) {
            const u = allUsers[key];
            document.getElementById('editKey').value = key;
            document.getElementById('editEmail').innerText = u.email;
            document.getElementById('editAvatar').src = u.photo || '';
            document.getElementById('editName').value = u.real_name || '';
            document.getElementById('editPhone').value = u.phone || '';
            document.getElementById('editGroup').value = u.group !== undefined ? u.group : 4;
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        function saveUser() {
            const key = document.getElementById('editKey').value;
            const name = document.getElementById('editName').value.trim();
            if(!name) return alert("Nh·∫≠p t√™n!");
            
            // B·∫£o v·ªá Admin ch√≠nh
            if (allUsers[key].email === ADMIN_EMAIL && document.getElementById('editGroup').value != 0) {
                return alert("Admin ch√≠nh ph·∫£i lu√¥n ·ªü Nh√≥m 0!");
            }

            db.ref('app_users/' + key).update({
                real_name: name,
                phone: document.getElementById('editPhone').value,
                group: parseInt(document.getElementById('editGroup').value) // L∆∞u s·ªë
            }).then(() => {
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                alert("ƒê√£ c·∫≠p nh·∫≠t!");
            });
        }
        function toggleBlock(k, s) { if(allUsers[k].email === ADMIN_EMAIL) return; db.ref('app_users/'+k).update({is_blocked: s}); }
    </script>
</body>
</html>
