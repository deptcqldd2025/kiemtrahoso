<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Nh√¢n S·ª± v4.2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .admin-header { background: #dc3545; color: white; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .user-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; border-left: 5px solid #198754; transition: 0.2s; }
        .user-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .user-card.blocked { border-left-color: #dc3545; background-color: #fff5f5; opacity: 0.8; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .role-badge { font-size: 11px; padding: 3px 8px; border-radius: 10px; text-transform: uppercase; font-weight: bold; }
        .role-manager { background: #dc3545; color: white; } /* L√£nh ƒë·∫°o - ƒê·ªè */
        .role-leader { background: #fd7e14; color: white; }  /* T·ªï tr∆∞·ªüng - Cam */
        .role-deputy { background: #ffc107; color: black; }   /* T·ªï ph√≥ - V√†ng */
        .role-worker { background: #e9ecef; color: #495057; } /* C√¥ng nh√¢n - X√°m */
    </style>
</head>
<body>

    <div class="admin-header d-flex align-items-center justify-content-between">
        <h5 class="m-0"><i class="fas fa-users-cog"></i> Qu·∫£n L√Ω Nh√¢n S·ª±</h5>
        <a href="index.html" class="btn btn-sm btn-light text-danger fw-bold"><i class="fas fa-home"></i> Trang ch·ªß</a>
    </div>

    <div class="container pb-5">
        <div class="row g-2 mb-3">
            <div class="col-12">
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="T√¨m t√™n, email ho·∫∑c sƒët..." oninput="renderList()">
                </div>
            </div>
            <div class="col-12 text-muted small d-flex justify-content-between">
                <span>T·ªïng s·ªë: <b id="totalUsers">0</b> nh√¢n vi√™n</span>
                <span>Version 4.2</span>
            </div>
        </div>

        <div id="userListContainer">
            <div class="text-center mt-5"><div class="spinner-border text-danger"></div><p class="mt-2 text-muted">ƒêang t·∫£i danh s√°ch...</p></div>
        </div>
    </div>

    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">C·∫≠p nh·∫≠t th√¥ng tin</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editKey">
                    <div class="mb-3 text-center">
                        <img id="editAvatar" src="" class="avatar mb-2">
                        <div id="editEmail" class="text-muted small fw-bold"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">H·ªç v√† T√™n hi·ªÉn th·ªã:</label>
                        <input type="text" id="editName" class="form-control" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i:</label>
                        <input type="text" id="editPhone" class="form-control" placeholder="09xxxx...">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Ch·ª©c v·ª• / Vai tr√≤:</label>
                        <select id="editRole" class="form-select bg-light border-primary">
                            <option value="worker">üë∑ C√¥ng nh√¢n (Ch·ªâ xem & s·ª≠a tuy·∫øn ƒë∆∞·ª£c giao)</option>
                            <option value="deputy">‚≠ê T·ªï ph√≥ (ƒê∆∞·ª£c s·ª≠a t·∫•t c·∫£ tuy·∫øn)</option>
                            <option value="leader">üåü T·ªï tr∆∞·ªüng (S·ª≠a t·∫•t c·∫£ + Ph√¢n c√¥ng)</option>
                            <option value="manager">üëë L√£nh ƒë·∫°o ƒê·ªôi (Qu·∫£n tr·ªã vi√™n)</option>
                        </select>
                        <div class="form-text small text-muted fst-italic mt-1">
                            * L√£nh ƒë·∫°o ƒê·ªôi c√≥ quy·ªÅn truy c·∫≠p trang n√†y v√† x√≥a d·ªØ li·ªáu.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // [CONFIG M·ªöI]
        const firebaseConfig = {
            apiKey: "AIzaSyALxXDNbFdXkI7XvHqiSNb1jnKjj0CbYnE",
            authDomain: "qldd-2025.firebaseapp.com",
            databaseURL: "https://qldd-2025-default-rtdb.firebaseio.com",
            projectId: "qldd-2025",
            storageBucket: "qldd-2025.firebasestorage.app",
            messagingSenderId: "84684010166",
            appId: "1:84684010166:web:bd9c3b5ae4227ee2812c17",
            measurementId: "G-7E5BDTCSEZ"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        
        // [ADMIN M·ªöI]
        const ADMIN_EMAIL = 'deptc.qldd2025@gmail.com';

        let allUsers = {};

        // 2. AUTH CHECK (B·∫¢O M·∫¨T)
        auth.onAuthStateChanged(user => {
            if (!user) {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");
                window.location.href = "index.html";
            } else {
                // Ki·ªÉm tra quy·ªÅn Admin trong DB
                const userKey = user.email.replace(/\./g, '_');
                db.ref('app_users/' + userKey).once('value').then(snap => {
                    const uData = snap.val();
                    // Cho ph√©p n·∫øu l√† Email Admin c·ª©ng HO·∫∂C c√≥ role l√† 'manager'
                    if (user.email === ADMIN_EMAIL || (uData && uData.role === 'manager')) {
                        initData();
                    } else {
                        alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã!");
                        window.location.href = "index.html";
                    }
                });
            }
        });

        // 3. LOAD DATA
        function initData() {
            db.ref('app_users').on('value', snap => {
                allUsers = snap.val() || {};
                renderList();
            });
        }

        // 4. RENDER LIST
        function renderList() {
            const container = document.getElementById('userListContainer');
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            container.innerHTML = '';
            
            const list = Object.entries(allUsers).filter(([key, u]) => {
                const searchStr = (u.real_name + u.email + (u.phone || '')).toLowerCase();
                return searchStr.includes(keyword);
            });

            document.getElementById('totalUsers').innerText = list.length;

            if(list.length === 0) {
                container.innerHTML = '<div class="text-center text-muted mt-4">Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n n√†o</div>';
                return;
            }

            list.forEach(([key, u]) => {
                const isBlocked = u.is_blocked === true;
                const role = u.role || 'worker';
                
                // Hi·ªÉn th·ªã t√™n Role ƒë·∫πp
                let roleLabel = 'C√¥ng nh√¢n';
                let roleClass = 'role-worker';
                
                if (role === 'deputy') { roleLabel = 'T·ªï ph√≥'; roleClass = 'role-deputy'; }
                if (role === 'leader') { roleLabel = 'T·ªï tr∆∞·ªüng'; roleClass = 'role-leader'; }
                if (role === 'manager') { roleLabel = 'L√£nh ƒë·∫°o'; roleClass = 'role-manager'; }

                const statusHtml = isBlocked 
                    ? `<span class="badge bg-danger ms-2"><i class="fas fa-lock"></i> ƒê√£ kh√≥a</span>` 
                    : ``;
                
                const btnBlock = isBlocked 
                    ? `<button class="btn btn-sm btn-outline-success ms-1" onclick="toggleBlock('${key}', false)" title="M·ªü kh√≥a"><i class="fas fa-unlock"></i></button>`
                    : `<button class="btn btn-sm btn-outline-danger ms-1" onclick="toggleBlock('${key}', true)" title="Kh√≥a t√†i kho·∫£n"><i class="fas fa-lock"></i></button>`;

                const phoneDisplay = u.phone ? `<i class="fas fa-phone-alt text-muted small me-1"></i> ${u.phone}` : `<span class="text-muted small fst-italic">--</span>`;

                container.innerHTML += `
                <div class="user-card p-3 ${isBlocked ? 'blocked' : ''}">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center" style="flex-grow: 1;">
                            <img src="${u.photo || 'https://via.placeholder.com/50'}" class="avatar me-3">
                            <div>
                                <h6 class="m-0 fw-bold text-dark">
                                    ${u.real_name || 'Ch∆∞a ƒë·∫∑t t√™n'} 
                                    <span class="badge ${roleClass} ms-1">${roleLabel}</span>
                                    ${statusHtml}
                                </h6>
                                <div class="small text-muted">${u.email}</div>
                                <div class="mt-1 text-secondary small">${phoneDisplay}</div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${key}')" title="S·ª≠a th√¥ng tin"><i class="fas fa-edit"></i></button>
                            ${btnBlock}
                        </div>
                    </div>
                    <div class="text-end mt-2 border-top pt-1 text-muted" style="font-size: 11px;">
                        <i class="fas fa-clock"></i> ƒêƒÉng nh·∫≠p cu·ªëi: ${formatTime(u.last_login)}
                    </div>
                </div>`;
            });
        }

        // 5. ACTIONS
        function toggleBlock(key, status) {
            const user = allUsers[key];
            if (user.email === ADMIN_EMAIL) return alert("Kh√¥ng th·ªÉ kh√≥a t√†i kho·∫£n Admin ch√≠nh!");
            
            if(confirm(status ? `B·∫°n mu·ªën KH√ìA t√†i kho·∫£n ${user.real_name || user.email}?` : `B·∫°n mu·ªën M·ªû KH√ìA cho ${user.real_name || user.email}?`)) {
                db.ref('app_users/' + key).update({ is_blocked: status });
            }
        }

        function openEditModal(key) {
            const u = allUsers[key];
            document.getElementById('editKey').value = key;
            document.getElementById('editEmail').innerText = u.email;
            document.getElementById('editAvatar').src = u.photo || 'https://via.placeholder.com/50';
            document.getElementById('editName').value = u.real_name || '';
            document.getElementById('editPhone').value = u.phone || '';
            document.getElementById('editRole').value = u.role || 'worker';
            
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        function saveUser() {
            const key = document.getElementById('editKey').value;
            const name = document.getElementById('editName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const role = document.getElementById('editRole').value;
            
            if(!name) return alert("T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");

            // Prevent changing main admin role to something else if editing self (optional safety)
            if (allUsers[key].email === ADMIN_EMAIL && role !== 'manager') {
                alert("T√†i kho·∫£n Admin ch√≠nh ph·∫£i lu√¥n l√† L√£nh ƒë·∫°o!");
                return;
            }

            db.ref('app_users/' + key).update({
                real_name: name,
                phone: phone,
                role: role
            }).then(() => {
                alert("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!");
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
            }).catch(e => alert("L·ªói: " + e.message));
        }

        function formatTime(iso) {
            if(!iso) return 'Ch∆∞a ƒëƒÉng nh·∫≠p';
            const d = new Date(iso);
            return `${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')} ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
        }
    </script>
</body>
</html>
