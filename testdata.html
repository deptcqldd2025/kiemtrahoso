<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug & Test Connection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', monospace; padding: 20px; }
        .log-box { background: #000; color: #0f0; padding: 15px; border-radius: 5px; height: 200px; overflow-y: auto; font-size: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .card { box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: none; margin-bottom: 15px; }
        .status-ok { color: green; font-weight: bold; }
        .status-err { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-bug text-danger"></i> Công cụ Kiểm tra Dữ liệu</h4>
        <a href="index.html" class="btn btn-secondary btn-sm">Về Trang chủ</a>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white fw-bold">1. Nhật ký kết nối (System Log)</div>
        <div class="card-body p-0">
            <div id="systemLog" class="log-box"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white fw-bold">2. Trạng thái Đăng nhập</div>
        <div class="card-body">
            <ul class="list-group list-group-flush" id="userInfo">
                <li class="list-group-item">Đang kiểm tra...</li>
            </ul>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-success text-white fw-bold d-flex justify-content-between">
            <span>3. Dữ liệu Tuyến dây (Raw Data)</span>
            <button class="btn btn-sm btn-light text-success" onclick="location.reload()">Tải lại</button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-bordered mb-0 small">
                    <thead class="table-light">
                        <tr>
                            <th>Tên Tuyến</th>
                            <th>ID Hệ thống</th>
                            <th>Người tạo</th>
                            <th>Số lượng File</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr><td colspan="5" class="text-center text-muted">Chưa có dữ liệu</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // --- CONFIG (Giống hệt index.html) ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };
        
        // --- HELPER LOG ---
        function log(msg, type='info') {
            const box = document.getElementById('systemLog');
            const time = new Date().toLocaleTimeString();
            let color = '#0f0'; // Green
            if(type==='error') color = '#f55'; // Red
            if(type==='warn') color = '#ff0'; // Yellow
            
            box.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        try {
            log("Khởi tạo Firebase...");
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const auth = firebase.auth();
            log("Firebase SDK OK.");

            // --- AUTH CHECK ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    log(`Đã đăng nhập: ${user.email}`);
                    renderUserInfo(user);
                    testDatabaseConnection();
                } else {
                    log("CHƯA ĐĂNG NHẬP! Dữ liệu sẽ không tải được (Permission Denied).", 'error');
                    document.getElementById('userInfo').innerHTML = `<li class="list-group-item text-danger fw-bold">Chưa đăng nhập. Vui lòng quay lại trang chủ để đăng nhập.</li>`;
                }
            });

        } catch (e) {
            log("Lỗi khởi tạo: " + e.message, 'error');
        }

        // --- RENDER USER ---
        function renderUserInfo(user) {
            const ul = document.getElementById('userInfo');
            ul.innerHTML = `
                <li class="list-group-item"><b>Email:</b> ${user.email}</li>
                <li class="list-group-item"><b>Tên hiển thị:</b> ${user.displayName}</li>
                <li class="list-group-item"><b>UID:</b> ${user.uid}</li>
            `;
        }

        // --- TEST DB ---
        function testDatabaseConnection() {
            log("Bắt đầu kết nối Database 'lines'...");
            const dbRef = firebase.database().ref('lines');
            
            dbRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const count = Object.keys(data).length;
                        log(`KẾT NỐI THÀNH CÔNG! Tìm thấy ${count} tuyến dây.`);
                        renderDataTable(data);
                    } else {
                        log("Kết nối thành công nhưng KHÔNG CÓ DỮ LIỆU (Null).", 'warn');
                        document.getElementById('dataTableBody').innerHTML = `<tr><td colspan="5" class="text-center text-warning">Database trống</td></tr>`;
                    }
                })
                .catch((error) => {
                    log("LỖI KẾT NỐI DATABASE: " + error.message, 'error');
                    log("Gợi ý: Kiểm tra lại Firebase Rules hoặc Mạng Internet.", 'warn');
                });
        }

        // --- RENDER TABLE ---
        function renderDataTable(lines) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            Object.entries(lines).forEach(([id, line]) => {
                // Đếm file
                let fileCount = 0;
                if (line.records) {
                    Object.values(line.records).forEach(rec => {
                        if (rec.files) fileCount += Object.keys(rec.files).length;
                        if (rec.link) fileCount++; // Legacy
                    });
                }

                // Trạng thái
                let status = '<span class="badge bg-success">Bình thường</span>';
                if (line.is_locked) status = '<span class="badge bg-danger">ĐANG KHÓA</span>';

                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-primary">${line.name}</td>
                        <td class="small text-muted font-monospace">${id}</td>
                        <td>${line.created_by || 'Unknown'}</td>
                        <td class="text-center fw-bold">${fileCount}</td>
                        <td>${status}</td>
                    </tr>
                `;
            });
            log("Đã hiển thị dữ liệu lên bảng.");
        }

    </script>
</body>
</html>
