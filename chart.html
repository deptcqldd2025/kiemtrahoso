<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống Kê - Đội QLDD v2.10</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .chart-header { background: #6610f2; color: white; padding: 15px; border-radius: 0 0 20px 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .chart-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .nav-pills .nav-link.active { background-color: #6610f2; }
        .nav-pills .nav-link { color: #6610f2; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loading" class="loading-screen">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Đang tải dữ liệu...</p>
    </div>

    <div class="chart-header d-flex align-items-center justify-content-between">
        <h5 class="m-0"><i class="fas fa-chart-line"></i> Thống Kê & Báo Cáo</h5>
        <a href="index.html" class="btn btn-sm btn-light text-primary fw-bold"><i class="fas fa-home"></i> Home</a>
    </div>

    <div class="container pb-5">
        
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-body p-2">
                <ul class="nav nav-pills nav-fill mb-2">
                    <li class="nav-item">
                        <a class="nav-link active" id="tabLine" onclick="switchMode('line')"><i class="fas fa-network-wired"></i> Theo Tuyến</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="tabUser" onclick="switchMode('user')"><i class="fas fa-user"></i> Theo Nhân Sự</a>
                    </li>
                </ul>
                
                <select id="mainSelect" class="form-select border-0 fw-bold text-primary" onchange="handleFilterChange()">
                    </select>
            </div>
        </div>

        <div class="chart-card">
            <h6 class="text-primary fw-bold mb-3" id="titleChart1">Tổng quan</h6>
            <div style="height: 300px;">
                <canvas id="chart1"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h6 class="text-warning fw-bold mb-3" id="titleChart2">Tiến độ theo thời gian</h6>
            <div style="height: 250px;">
                <canvas id="chart2"></canvas>
            </div>
        </div>

        <div class="chart-card" id="statsCard">
            <h6 class="text-success fw-bold mb-3">Chi tiết số liệu</h6>
            <ul class="list-group list-group-flush small">
                <li class="list-group-item d-flex justify-content-between">
                    <span>Tổng file đã làm:</span>
                    <strong id="stTotal">0</strong>
                </li>
                <div id="dynamicStats"></div>
            </ul>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        const TOTAL_ITEMS_PER_LINE = 38; 

        let allLinesData = {};
        let allUsersData = {};
        let chartInstance1 = null;
        let chartInstance2 = null;
        let currentMode = 'line'; // 'line' or 'user'

        auth.onAuthStateChanged(user => {
            if (!user) { window.location.href = "index.html"; }
            else { initData(); }
        });

        function initData() {
            db.ref('app_users').once('value').then(snap => {
                allUsersData = snap.val() || {};
                db.ref('lines').on('value', snap => {
                    allLinesData = snap.val() || {};
                    switchMode('line'); // Default view
                    document.getElementById('loading').style.display = 'none';
                });
            });
        }

        function getRealName(email) {
            if(!email) return 'Ẩn danh';
            const k = email.replace(/\./g, '_');
            return (allUsersData[k]?.real_name) ? allUsersData[k].real_name : email.split('@')[0];
        }

        // --- MODE SWITCHING ---
        function switchMode(mode) {
            currentMode = mode;
            // Update Tab UI
            document.getElementById('tabLine').classList.toggle('active', mode === 'line');
            document.getElementById('tabUser').classList.toggle('active', mode === 'user');
            
            const select = document.getElementById('mainSelect');
            select.innerHTML = '';

            if (mode === 'line') {
                select.innerHTML = '<option value="">-- Toàn bộ hệ thống --</option>';
                Object.entries(allLinesData).forEach(([id, line]) => {
                    select.innerHTML += `<option value="${id}">${line.name}</option>`;
                });
            } else {
                select.innerHTML = '<option value="">-- Chọn nhân viên --</option>';
                // Get list of users who actually contributed
                const activeUsers = new Set();
                Object.values(allLinesData).forEach(l => {
                    if(l.records) Object.values(l.records).forEach(r => {
                        if(r.files) Object.values(r.files).forEach(f => activeUsers.add(f.user));
                    });
                });
                
                activeUsers.forEach(email => {
                    select.innerHTML += `<option value="${email}">${getRealName(email)}</option>`;
                });
            }
            handleFilterChange();
        }

        function handleFilterChange() {
            const val = document.getElementById('mainSelect').value;
            if (currentMode === 'line') renderLineStats(val);
            else renderUserStats(val);
        }

        // --- LOGIC 1: LINE STATS (Như cũ) ---
        function renderLineStats(lineId) {
            document.getElementById('titleChart1').innerText = "Hiệu suất Nhân sự (Ai làm nhiều nhất?)";
            document.getElementById('titleChart2').innerText = "Tốc độ nhập liệu (File/Ngày)";
            
            const userCounts = {};
            const timeline = {};
            let totalFiles = 0;

            const processLine = (line) => {
                if(line.records) Object.values(line.records).forEach(r => {
                    if(r.files) Object.values(r.files).forEach(f => {
                        // User Count
                        const uname = getRealName(f.user);
                        userCounts[uname] = (userCounts[uname] || 0) + 1;
                        
                        // Timeline
                        const date = new Date(f.created_at).toISOString().split('T')[0];
                        timeline[date] = (timeline[date] || 0) + 1;
                        
                        totalFiles++;
                    });
                });
            };

            if(lineId && allLinesData[lineId]) processLine(allLinesData[lineId]);
            else Object.values(allLinesData).forEach(processLine);

            // Chart 1: Bar Chart (User Contribution)
            const labels1 = Object.keys(userCounts);
            const data1 = Object.values(userCounts);
            drawChart1('bar', labels1, data1, 'Số lượng file');

            // Chart 2: Line Chart (Growth)
            const sortedDates = Object.keys(timeline).sort();
            const labels2 = [];
            const data2 = [];
            let acc = 0;
            sortedDates.forEach(d => {
                acc += timeline[d];
                labels2.push(d.split('-').slice(1).reverse().join('/'));
                data2.push(acc);
            });
            drawChart2(labels2, data2);

            // Stats
            document.getElementById('stTotal').innerText = totalFiles;
            document.getElementById('dynamicStats').innerHTML = `<li class="list-group-item">Dữ liệu đang xem: <b>${lineId ? '1 Tuyến' : 'Toàn bộ'}</b></li>`;
        }

        // --- LOGIC 2: USER STATS (Mới) ---
        function renderUserStats(userEmail) {
            document.getElementById('titleChart1').innerText = "Phân bố công việc (Làm ở tuyến nào?)";
            document.getElementById('titleChart2').innerText = "Lịch sử hoạt động cá nhân";

            if (!userEmail) {
                // Nếu chưa chọn user nào -> Clear charts
                if(chartInstance1) chartInstance1.destroy();
                if(chartInstance2) chartInstance2.destroy();
                document.getElementById('stTotal').innerText = 0;
                document.getElementById('dynamicStats').innerHTML = '';
                return;
            }

            const lineCounts = {};
            const timeline = {};
            let totalFiles = 0;

            Object.entries(allLinesData).forEach(([lid, line]) => {
                let countForLine = 0;
                if(line.records) Object.values(line.records).forEach(r => {
                    if(r.files) Object.values(r.files).forEach(f => {
                        if (f.user === userEmail) {
                            countForLine++;
                            // Timeline
                            const date = new Date(f.created_at).toISOString().split('T')[0];
                            timeline[date] = (timeline[date] || 0) + 1;
                            totalFiles++;
                        }
                    });
                });
                if(countForLine > 0) lineCounts[line.name] = countForLine;
            });

            // Chart 1: Bar Chart (Work by Line) - Horizontal Bar looks better for names
            const labels1 = Object.keys(lineCounts);
            const data1 = Object.values(lineCounts);
            drawChart1('bar', labels1, data1, 'Số file đóng góp', 'y'); // Index axis y

            // Chart 2: Line Chart (Personal Growth)
            const sortedDates = Object.keys(timeline).sort();
            const labels2 = [];
            const data2 = [];
            let acc = 0;
            sortedDates.forEach(d => {
                acc += timeline[d];
                labels2.push(d.split('-').slice(1).reverse().join('/'));
                data2.push(acc);
            });
            drawChart2(labels2, data2);

            // Stats
            document.getElementById('stTotal').innerText = totalFiles;
            document.getElementById('dynamicStats').innerHTML = `<li class="list-group-item">Đang xem nhân viên: <b class="text-primary">${getRealName(userEmail)}</b></li>`;
        }

        // --- DRAWING FUNCTIONS ---
        function drawChart1(type, labels, data, labelName, indexAxis = 'x') {
            const ctx = document.getElementById('chart1').getContext('2d');
            if(chartInstance1) chartInstance1.destroy();
            
            // Random color generator
            const bgColors = labels.map(() => `hsl(${Math.random() * 360}, 70%, 50%)`);

            chartInstance1 = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelName,
                        data: data,
                        backgroundColor: bgColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: indexAxis,
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function drawChart2(labels, data) {
            const ctx = document.getElementById('chart2').getContext('2d');
            if(chartInstance2) chartInstance2.destroy();

            chartInstance2 = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tích lũy',
                        data: data,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    </script>
</body>
</html>
