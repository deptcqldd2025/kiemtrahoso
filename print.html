<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bi√™n B·∫£n Ki·ªÉm Tra H·ªì S∆°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* C·∫•u h√¨nh kh·ªï gi·∫•y A4 */
        @page { size: A4; margin: 2cm 1.5cm; }
        body { font-family: "Times New Roman", Times, serif; font-size: 13pt; line-height: 1.3; color: #000; background: #fff; }
        
        /* ·∫®n c√°c th√†nh ph·∫ßn kh√¥ng c·∫ßn in */
        @media print {
            .no-print { display: none !important; }
            body { padding: 0; }
            .table-bordered th, .table-bordered td { border: 1px solid #000 !important; }
        }

        /* Style hi·ªÉn th·ªã tr√™n m√†n h√¨nh */
        .print-container { max-width: 210mm; margin: 0 auto; padding: 10px; background: white; min-height: 297mm; }
        .header-tbl td { vertical-align: top; text-align: center; }
        .section-title { text-transform: uppercase; font-weight: bold; margin-top: 15px; margin-bottom: 5px; }
        .sign-table { margin-top: 30px; width: 100%; text-align: center; }
        .sign-table td { vertical-align: top; height: 100px; }
        
        /* Loading Overlay */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu bi√™n b·∫£n...</p>
    </div>

    <div class="fixed-top bg-dark p-2 text-center no-print d-flex justify-content-center gap-2">
        <button class="btn btn-sm btn-light" onclick="window.close()">Quay l·∫°i</button>
        <button class="btn btn-sm btn-primary" onclick="window.print()">üñ®Ô∏è In Ngay / L∆∞u PDF</button>
    </div>
    <div style="height: 50px;" class="no-print"></div>

    <div class="print-container">
        
        <table class="header-tbl" style="width: 100%; margin-bottom: 20px;">
            <tr>
                <td style="width: 45%;">
                    C√îNG TY ƒêI·ªÜN L·ª∞C G√í V·∫§P<br>
                    <b>ƒê·ªòI QU·∫¢N L√ù ƒê∆Ø·ªúNG D√ÇY</b><br>
                    ----------------
                </td>
                <td style="width: 55%;">
                    <b>C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</b><br>
                    <b>ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</b><br>
                    ----------------
                </td>
            </tr>
            <tr>
                <td colspan="2" style="padding-top: 25px;">
                    <h4 style="margin: 0; font-weight: bold;">BI√äN B·∫¢N KI·ªÇM TRA H·ªí S∆† L∆Ø·ªöI ƒêI·ªÜN</h4>
                    <i id="lblDate">Tp.HCM, ng√†y ... th√°ng ... nƒÉm ...</i>
                </td>
            </tr>
        </table>

        <div class="section-title">I. TH√îNG TIN CHUNG</div>
        <p class="mb-1">1. T√™n c√¥ng tr√¨nh/Tuy·∫øn d√¢y: <b id="lblLineName">...</b></p>
        <p class="mb-1">2. ƒê∆°n v·ªã qu·∫£n l√Ω: <b>ƒê·ªôi Qu·∫£n l√Ω ƒë∆∞·ªùng d√¢y</b></p>
        <p class="mb-1">3. Ng∆∞·ªùi th·ª±c hi·ªán ki·ªÉm k√™: <b id="lblUserName">...</b></p>

        <div class="section-title">II. K·∫æT QU·∫¢ R√Ä SO√ÅT H·ªí S∆†</div>
        <table class="table table-bordered table-sm">
            <thead>
                <tr class="text-center bg-light">
                    <th style="width: 10px;">TT</th>
                    <th>Danh m·ª•c h·ªì s∆°</th>
                    <th style="width: 50px;">SL File</th>
                    <th style="width: 100px;">Tr·∫°ng th√°i</th>
                    <th>Ghi ch√∫ / Chi ti·∫øt</th>
                </tr>
            </thead>
            <tbody id="printBody">
                </tbody>
        </table>

        <div class="section-title">III. T·ªîNG H·ª¢P & K·∫æT LU·∫¨N</div>
        <ul class="mb-2">
            <li>T·ªïng s·ªë ƒë·∫ßu m·ª•c quy ƒë·ªãnh: <b id="statTotal">0</b> m·ª•c.</li>
            <li>S·ªë ƒë·∫ßu m·ª•c ƒë√£ c√≥ h·ªì s∆°: <b id="statDone">0</b> m·ª•c.</li>
            <li>S·ªë ƒë·∫ßu m·ª•c x√°c nh·∫≠n KH√îNG C√ì: <b id="statNoRecord">0</b> m·ª•c.</li>
            <li>S·ªë ƒë·∫ßu m·ª•c ch∆∞a ki·ªÉm tra: <b id="statMissing">0</b> m·ª•c.</li>
        </ul>
        <p><b>ƒê√°nh gi√° s∆° b·ªô:</b> ....................................................................................................................................</p>
        <p>...........................................................................................................................................................................</p>

        <table class="sign-table">
            <tr>
                <td style="width: 50%;">
                    <b>ƒê·∫†I DI·ªÜN ƒê∆†N V·ªä THI C√îNG</b><br>
                    <i>(K√Ω, ghi r√µ h·ªç t√™n)</i>
                </td>
                <td style="width: 50%;">
                    <b>NG∆Ø·ªúI L·∫¨P BI√äN B·∫¢N</b><br>
                    <i>(K√Ω, ghi r√µ h·ªç t√™n)</i><br><br><br><br>
                    <b id="lblSignName">...</b>
                </td>
            </tr>
        </table>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // 1. CONFIG (Gi·ªëng index.html)
        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // 2. DANH M·ª§C (Ph·∫£i kh·ªõp v·ªõi index.html)
        const DOC_CATEGORIES = {
            "A. H·ªí S∆† QU·∫¢N L√ù V·∫¨N H√ÄNH": [ { id: 'thong_so_ky_thuat', name: 'Th√¥ng s·ªë k·ªπ thu·∫≠t ƒêZ' }, { id: 'theo_doi_dong_cat', name: 'B·∫£ng theo d√µi ƒë√≥ng c·∫Øt' }, { id: 'theo_doi_su_co', name: 'B·∫£ng Theo d√µi S·ª± c·ªë' }, { id: 'theo_doi_phu_tai', name: 'B·∫£ng thao d√µi Ph·ª• t·∫£i' }, { id: 'theo_doi_hanh_lang', name: 'B·∫£ng Theo d√µi k·ªπ thu·∫≠t h√†nh lang' }, { id: 'theo_doi_dai_tu', name: 'B·∫£ng theo d√µi c√¥ng t√°c ƒë·∫°i tu' }, { id: 'tong_hop_ton_tai', name: 'B·∫£ng t·ªïng h·ª£p t·ªìn t·∫°i' }, { id: 'bang_phan_bo_cot', name: 'B·∫£ng ph√¢n b·ªë c·ªôt' }, { id: 'bang_giao_cheo', name: 'B·∫£ng giao ch√©o' }, { id: 'bang_do_do_vong', name: 'B·∫£ng ƒëo ƒë·ªô v√µng' }, { id: 'bao_cao_nhiet_do', name: 'B·∫£ng b√°o c√°o nhi·ªát ƒë·ªô' }, { id: 'bao_cao_dien_tro', name: 'B·∫£ng b√°o c√°o ƒëi·ªán tr·ªü' }, { id: 'ho_so_thu_tu_pha', name: 'H·ªì s∆° th·ª© t·ª± pha' }, { id: 'hinh_anh_tru', name: 'H√¨nh ·∫¢nh tr·ª•' }, { id: 'bb_ktdk_ngay', name: 'Bi√™n b·∫£n KTƒêK ng√†y' }, { id: 'bb_ktdk_dem', name: 'Bi√™n b·∫£n KTƒêK ƒë√™m' }, { id: 'theo_doi_nha_cong_trinh', name: 'H·ªì s∆° theo d√µi nh√†/c√¥ng tr√¨nh' } ],
            "B. H·ªí S∆† THI·∫æT K·∫æ": [ { id: 'hs_mong_tru', name: 'H·ªì s∆° m√≥ng tr·ª•' }, { id: 'hs_den_bu', name: 'H·ªì s∆° ƒë·ªÅn b√π' }, { id: 'hs_nghiem_thu', name: 'H·ªì s∆° nghi·ªám thu' }, { id: 'hs_thiet_ke', name: 'H·ªì s∆° thi·∫øt k·∫ø' }, { id: 'hs_du_thau', name: 'H·ªì s∆° d·ª± th·∫ßu' } ],
            "C. H·ªí S∆† HO√ÄN C√îNG": [ { id: 'hc_phan_mong_tru', name: 'H·ªì s∆° ho√†n c√¥ng ph·∫ßn m√≥ng tr·ª•' }, { id: 'hc_phan_tru', name: 'H·ªì s∆° ho√†n c√¥ng ph·∫ßn tr·ª•' }, { id: 'bv_hc_phan_mong', name: 'B·∫£n v·∫Ω ho√†n c√¥ng ph·∫ßn m√≥ng' }, { id: 'bv_hc_phan_tru', name: 'B·∫£n v·∫Ω ho√†n c√¥ng ph·∫ßn tr·ª•' }, { id: 'bv_hc_cap', name: 'B·∫£n v·∫Ω ho√†n c√¥ng h·∫ßm c√°p, tuy·∫øn c√°p, m·ªëc c√°p' }, { id: 'ban_do_dien_tro', name: 'B·∫£n ƒëo ƒëi·ªán tr·ªü' }, { id: 'ban_do_do_vong', name: 'B·∫£n ƒëo ƒë·ªô v√µng' }, { id: 'ban_quan_trac_tru', name: 'B·∫£n quan tr·∫Øc tr·ª•' }, { id: 'toa_do_vn2000', name: 'T·ªça ƒë·ªô VN2000 ph·∫ßn DDK v√† c√°p ng·∫ßm' }, { id: 'ban_phan_bo_cot', name: 'B·∫£n ph√¢n b·ªë c·ªôt' }, { id: 'so_do_thu_tu_pha', name: 'S∆° ƒë·ªì th·ª© t·ª± pha' }, { id: 'ban_giao_cheo_gt', name: 'B·∫£n giao ch√©o ƒë∆∞·ªùng b·ªô, s·∫Øt, s√¥ng' }, { id: 'ban_giao_cheo_dien', name: 'B·∫£n giao ch√©o l∆∞·ªõi ƒëi·ªán v√† ƒë√®n chi·∫øu s√°ng' }, { id: 'tk_nha_hanh_lang', name: 'B·∫£ng th·ªëng k√™ nh√† trong h√†nh lang' }, { id: 'tk_nha_25m', name: 'B·∫£ng th·ªëng k√™ nh√† trong ph·∫°m v·ªã 25 m√©t' }, { id: 'hs_boi_thuong', name: 'H·ªì s∆° b·ªìi th∆∞·ªùng' } ]
        };

        // 3. LOGIC L·∫§Y D·ªÆ LI·ªÜU
        auth.onAuthStateChanged(user => {
            if (!user) {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p t·ª´ trang ch·ªß tr∆∞·ªõc!");
                window.location.href = "index.html";
                return;
            }
            
            // L·∫•y ID tuy·∫øn d√¢y t·ª´ URL (V√≠ d·ª•: print.html?id=line_123456)
            const params = new URLSearchParams(window.location.search);
            const lineId = params.get('id');
            
            if(!lineId) {
                alert("Kh√¥ng t√¨m th·∫•y m√£ tuy·∫øn d√¢y!");
                return;
            }

            loadData(lineId, user);
        });

        async function loadData(lineId, user) {
            const snap = await db.ref('lines/' + lineId).once('value');
            const data = snap.val();
            
            if(!data) {
                alert("D·ªØ li·ªáu tuy·∫øn d√¢y kh√¥ng t·ªìn t·∫°i!");
                return;
            }

            // ƒêi·ªÅn th√¥ng tin chung
            document.getElementById('lblLineName').innerText = data.name.toUpperCase();
            document.getElementById('lblUserName').innerText = user.displayName;
            document.getElementById('lblSignName').innerText = user.displayName;
            
            const now = new Date();
            document.getElementById('lblDate').innerText = `Tp.HCM, ng√†y ${now.getDate()} th√°ng ${now.getMonth()+1} nƒÉm ${now.getFullYear()}`;

            // Render B·∫£ng
            const tbody = document.getElementById('printBody');
            let statTotal = 0, statDone = 0, statNoRecord = 0;

            Object.entries(DOC_CATEGORIES).forEach(([groupName, items]) => {
                // Header nh√≥m
                tbody.innerHTML += `<tr class="table-active"><td colspan="5"><b>${groupName}</b></td></tr>`;
                
                items.forEach((item, index) => {
                    statTotal++;
                    const rec = (data.records && data.records[item.id]) ? data.records[item.id] : {};
                    const files = rec.files || {};
                    if(rec.link && !rec.files) files['old'] = {note: 'D·ªØ li·ªáu c≈©'}; // Legacy support

                    const fileCount = Object.keys(files).length;
                    const isNoRecord = rec.no_record === true;
                    
                    let statusText = '<span style="color:gray">Ch∆∞a KT</span>';
                    let noteText = '';

                    if(fileCount > 0) {
                        statusText = '<b>ƒê√£ c√≥</b>';
                        statDone++;
                        // Gh√©p c√°c ghi ch√∫ l·∫°i
                        noteText = Object.values(files).map(f => f.note).join('; ');
                    } else if (isNoRecord) {
                        statusText = '<b>KH√îNG C√ì</b>';
                        statNoRecord++;
                        noteText = 'ƒê√£ x√°c nh·∫≠n kh√¥ng c√≥ h·ªì s∆°';
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td>${item.name}</td>
                            <td class="text-center">${fileCount || '-'}</td>
                            <td class="text-center">${statusText}</td>
                            <td>${noteText}</td>
                        </tr>
                    `;
                });
            });

            // Update Th·ªëng k√™
            document.getElementById('statTotal').innerText = statTotal;
            document.getElementById('statDone').innerText = statDone;
            document.getElementById('statNoRecord').innerText = statNoRecord;
            document.getElementById('statMissing').innerText = statTotal - statDone - statNoRecord;

            // Xong
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
