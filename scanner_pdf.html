<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Tài Liệu sang PDF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .app-header { background: #2c3e50; color: white; padding: 15px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Khung hiển thị ảnh đã chụp */
        .page-item { position: relative; display: inline-block; margin: 10px; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .page-thumb { width: 100px; height: 140px; object-fit: cover; opacity: 0.9; }
        .page-number { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 12px; text-align: center; padding: 2px; }
        .btn-remove { position: absolute; top: 2px; right: 2px; background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        /* Nút chụp ảnh lớn */
        .btn-camera-wrapper { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100; }
        .btn-camera { width: 70px; height: 70px; border-radius: 50%; background: #0d6efd; color: white; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 28px; display: flex; align-items: center; justify-content: center; }
        .btn-camera:active { transform: scale(0.95); background: #0b5ed7; }

        /* Vùng hướng dẫn khi chưa có ảnh */
        .empty-state { text-align: center; padding: 50px 20px; color: #6c757d; }
    </style>
</head>
<body>

    <div class="app-header text-center mb-3">
        <h5 class="m-0"><i class="fas fa-file-pdf"></i> Máy Scan Di Động</h5>
        <small>Chụp nhiều trang & Xuất PDF</small>
    </div>

    <div class="container pb-5 mb-5">
        <div id="pagesContainer" class="text-center">
            </div>

        <div id="emptyState" class="empty-state">
            <i class="fas fa-camera fa-4x mb-3 text-secondary"></i>
            <p>Chưa có trang nào.<br>Bấm nút Camera bên dưới để bắt đầu chụp.</p>
        </div>

        <div class="row g-2 px-3 mt-3" id="actionButtons" style="display: none;">
            <div class="col-12">
                <button class="btn btn-success w-100 py-3 fw-bold shadow-sm" onclick="generatePDF()">
                    <i class="fas fa-file-download me-2"></i> Xuất File PDF
                </button>
            </div>
            <div class="col-12 text-center mt-2">
                <small class="text-muted" id="pageCount">0 trang đã chụp</small>
            </div>
        </div>
    </div>

    <div class="btn-camera-wrapper">
        <label for="cameraInput" class="btn-camera">
            <i class="fas fa-camera"></i>
        </label>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden onchange="handleImageCapture(this)">
    </div>

    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; text-align: center; color: white; padding-top: 50vh;">
        <div class="spinner-border text-light" role="status"></div>
        <p class="mt-2">Đang xử lý ảnh...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        const { jsPDF } = window.jspdf;
        let capturedPages = []; // Mảng chứa dữ liệu ảnh (Base64)

        // 1. XỬ LÝ KHI CHỤP ẢNH
        async function handleImageCapture(input) {
            if (input.files && input.files[0]) {
                showLoading(true);
                const file = input.files[0];
                
                try {
                    // Nén ảnh trước khi lưu (để PDF không bị quá nặng)
                    const compressedBase64 = await compressImage(file);
                    
                    // Thêm vào mảng
                    capturedPages.push(compressedBase64);
                    
                    // Cập nhật giao diện
                    renderPages();
                } catch (error) {
                    alert("Lỗi xử lý ảnh: " + error);
                } finally {
                    showLoading(false);
                    input.value = ''; // Reset input để chụp tiếp
                }
            }
        }

        // 2. HÀM NÉN ẢNH (Dùng Canvas)
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        // Tạo canvas để vẽ lại ảnh (resize)
                        const canvas = document.createElement('canvas');
                        // Giới hạn chiều rộng max là 1024px (đủ nét cho A4 mà nhẹ)
                        const maxWidth = 1024;
                        const scaleSize = maxWidth / img.width;
                        const newWidth = maxWidth;
                        const newHeight = img.height * scaleSize;

                        canvas.width = newWidth;
                        canvas.height = newHeight;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, newWidth, newHeight);

                        // Xuất ra dạng JPEG chất lượng 0.7
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl);
                    };
                    img.onerror = (err) => reject(err);
                };
            });
        }

        // 3. HIỂN THỊ DANH SÁCH TRANG
        function renderPages() {
            const container = document.getElementById('pagesContainer');
            const emptyState = document.getElementById('emptyState');
            const actionButtons = document.getElementById('actionButtons');
            const pageCountLabel = document.getElementById('pageCount');

            container.innerHTML = '';

            if (capturedPages.length === 0) {
                emptyState.style.display = 'block';
                actionButtons.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                actionButtons.style.display = 'flex';
                pageCountLabel.innerText = `${capturedPages.length} trang đã chụp`;

                capturedPages.forEach((imgData, index) => {
                    const div = document.createElement('div');
                    div.className = 'page-item';
                    div.innerHTML = `
                        <img src="${imgData}" class="page-thumb">
                        <div class="page-number">Trang ${index + 1}</div>
                        <button class="btn-remove" onclick="removePage(${index})"><i class="fas fa-times"></i></button>
                    `;
                    container.appendChild(div);
                });
            }
        }

        // 4. XÓA TRANG
        function removePage(index) {
            if (confirm("Xóa trang này?")) {
                capturedPages.splice(index, 1);
                renderPages();
            }
        }

        // 5. XUẤT PDF
        function generatePDF() {
            if (capturedPages.length === 0) return;
            
            showLoading(true);
            
            // Dùng setTimeout để UI kịp hiển thị loading
            setTimeout(() => {
                try {
                    // Tạo file PDF khổ A4
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();

                    capturedPages.forEach((imgData, index) => {
                        if (index > 0) doc.addPage(); // Thêm trang mới nếu không phải trang đầu

                        // Lấy kích thước ảnh để tính tỷ lệ
                        const imgProps = doc.getImageProperties(imgData);
                        const imgRatio = imgProps.width / imgProps.height;
                        
                        // Tính toán kích thước vẽ (Fit width)
                        // Lề 10mm mỗi bên
                        const margin = 10;
                        const finalWidth = pageWidth - (margin * 2); 
                        const finalHeight = finalWidth / imgRatio;

                        // Nếu ảnh dài quá trang (dọc), thì co lại cho vừa chiều cao
                        if (finalHeight > (pageHeight - margin * 2)) {
                           // Logic fit height nếu cần, nhưng thường tài liệu chụp dọc nên fit width là ổn
                        }

                        doc.addImage(imgData, 'JPEG', margin, margin, finalWidth, finalHeight);
                    });

                    // Đặt tên file theo thời gian
                    const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,"-");
                    const fileName = `Scan_TaiLieu_${timestamp}.pdf`;
                    
                    doc.save(fileName);
                } catch (error) {
                    alert("Lỗi tạo PDF: " + error);
                } finally {
                    showLoading(false);
                }
            }, 500);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
